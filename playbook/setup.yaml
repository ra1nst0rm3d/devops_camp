---
- name: setup server
  hosts: all
  vars:
    ssh_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65336364353762633937636435653431353066336165643839393232323262653434613133343263
          3563333931353830643139393863303533383164306666340a613334306632346431653964326162
          32633331373462316630373130373536323236303933373237636137346131646261333365363531
          3332633334393133650a613337616136623839623235623131393731366366333737333737663366
          33353565623139373466613565613939343833393738343163646662633838666236393862313162
          33346563616536373330633061363364383731356365376330363762346365386661343436343730
          62333535363337666337633935353438636465333462376231636461363532633464323866343262
          34633539373833393563653361356235303936323130366231346263653861646333396165373937
          34303137323661643138393235663265316338316139336530643764383266323936313539346363
          66316164336430383537653565646231323537373164346630346230626234636535663437363934
          38353230386135373465336637323538626132613639666562353139386462626131643863393261
          66623534653930346263386466326230326631323938386661356231306336373464333635393964
          65633332656262623463616331323937393931663536666566656430323264366333643430333761
          62346463646563616532393338643731336531393134396162656534616435356161323961303633
          39616664323930656461353830373934326334646333623861616533396439386130396663656535
          33343535613630626238663864303265653865356265333137373164626234653534393739303437
          65316266363864356462386364353035363432383437333564653338373030346362363038363233
          61376339363736323035646335333335343237373230376564663566346362313630306130313039
          31643137636463373263636335303961373434303633326265376639373232316632303430366334
          62323734363565353630663637373837343236393438343732353935393633303431643734323332
          34393435616335333833393037633830303734316335336664643566663330383761356632343934
          37313164303163613832363830303439643264333238383065303361633933613830303962373262
          37303432633736356530313633363963303730363665626562646534313866353132613036663966
          38646661653139306461363635333731653232396237393462376364323238663135326237623733
          31643565343165653064316433383833336134343262643833373834373032646130343936616132
          38316239383634356231373435346364323661306366313436633731396236663164346663383332
          37336162316635633363306630636330323933616361643039383961326430366533613330666135
          33383037366338653562353366373963346661633365356436616561646136303033303039396166
          34653639623135653235666439663664363464623631333634306663363832646561376663353364
          38626537653238333162393464383263313231623965653033613234663131373564303362663765
          65643961626431313937626461353631636462306138633965356364333963353262613962663033
          61333963663532613435
    user: cloudru
    password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63396339333664323235366638643932313665376462313331353461623665303363646237386231
          3938356632386637356436393336386463343532613735620a326262363638376538346666616431
          32313137316637353039383462343562373166393530616233363064333338373134396633323631
          3938666266333163650a623230623964373739623035303731613133643562306565316438616565
          37383237363836626365663764653136386664373263393365343631626162313331376362343334
          63633165383765376234316238303530393937653961613033336631646462323930343236646238
          33666236313862343132626563663636376232613663306166383862383939366563353731333634
          31613262366333363766383332333565353539333064613066386234663762393937326632623539
          3738
  become: yes
  gather_facts: no

  tasks:

    - name: install authorized_key module
      shell: "ansible-galaxy collection install ansible.posix"

    - name: create user cloudru with specified password
      user:
        name: "{{user}}"
        password: "{{password}}" # запрошенный пароль с солью ra1n
        create_home: yes

    - name: check if openssh server is installed and if not, install it then
      apt:
        name: 'openssh-server'
        state: present
    
    - name: disable any password methods on sshd
      shell: 
        cmd: |
          cat <<EOF | sudo tee /etc/ssh/sshd_config.d/10-ansible-setup.conf
          ChallengeResponseAuthentication no
          PasswordAuthentication no
          PermitRootLogin no
          EOF

    - name: run sshd by systemd
      systemd:
        name: sshd
        enabled: yes
        state: started
    
    - name: create .ssh directory
      file:
        path: /home/{{user}}/.ssh/
        state: directory
        owner: "{{user}}"
        group: "{{user}}"
        mode: 0755
    
    - name: set new public key for user cloudru # Честно, обратил внимание на потенциальную опечатку в последнем пункте задания, где сказано установить ключ юзеру cloudpass
      ansible.posix.authorized_key:
        state: present
        key: "{{ssh_key}}"
        user: "{{user}}"
        
