---
- name: setup server
  hosts: localhost
  vars_files:
    - "vars/main.yaml"
  become: yes
  gather_facts: no

  tasks:

    - name: install authorized_key module
      shell: "ansible-galaxy collection install ansible.posix"

    - name: create user cloudru with specified password
      user:
        name: "{{user}}"
        password: "{{password}}" # запрошенный пароль с солью ra1n
        create_home: yes

    - name: check if openssh server is installed and if not, install it then
      apt:
        name: 'openssh-server'
        state: present
    
    - name: disable any password methods on sshd
      shell: 
        cmd: |
          cat <<EOF | sudo tee /etc/ssh/sshd_config.d/10-ansible-setup.conf
          ChallengeResponseAuthentication no
          PasswordAuthentication no
          PermitRootLogin no
          EOF

    - name: run sshd by systemd
      systemd:
        name: sshd
        enabled: yes
        state: started
    
    - name: create .ssh directory
      file:
        path: /home/{{user}}/.ssh/
        state: directory
        owner: "{{user}}"
        group: "{{user}}"
        mode: 0755
    
    - name: set new public key for user cloudru # Честно, обратил внимание на потенциальную опечатку в последнем пункте задания, где сказано установить ключ юзеру cloudpass
      ansible.posix.authorized_key:
        state: present
        key: "{{ssh_key}}"
        user: "{{user}}"
        
